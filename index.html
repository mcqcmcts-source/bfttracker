<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Military BFT Tracker</title>
  <!-- Original styles and UI preserved -->
  <style>
    /* ... Paste your original full CSS from your file here ... */
    /* For brevity, this is a placeholder */
    body {
      background: linear-gradient(135deg, #1a2e1a 0%, #0f1b0f 50%, #1a2e1a 100%);
      font-family: 'Inter', sans-serif;
      color: #86efac;
      margin: 0;
    }
    /* Add all your original styles here */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="mobile-container">
    <!-- Insert your full HTML markup from your pasted file here preserving original structure -->
    <!-- Example partial for login UI -->
    <div id="loginScreen" class="mobile-content">
      <div class="mobile-card">
        <h2>Access BFT Tracker</h2>
        <label>Service Number</label>
        <input type="text" id="loginServiceNumber" placeholder="Enter your Service Number"/>
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password"/>
        <button onclick="login()">Sign In</button>
        <button onclick="showSignup()">Create Account</button>
      </div>
    </div>

    <div id="signupScreen" class="mobile-content" style="display:none;">
      <div class="mobile-card">
        <h2>Create Account</h2>
        <label>Service Number</label>
        <input type="text" id="signupServiceNumber" placeholder="Enter your Service Number"/>
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="Create a password"/>
        <label>Confirm Password</label>
        <input type="password" id="confirmPassword" placeholder="Confirm password"/>
        <label>Full Name</label>
        <input type="text" id="signupName" placeholder="Enter your full name"/>
        <label>Rank</label>
        <input type="text" id="signupRank" placeholder="Enter your rank"/>
        <label>Unit</label>
        <input type="text" id="signupUnit" placeholder="Enter your unit"/>
        <button onclick="signup()">Create Account</button>
        <button onclick="showLogin()">Back to Login</button>
      </div>
    </div>

    <div id="mainApp" class="mobile-content" style="display:none;">
      <div class="mobile-card">
        <h2>Your Profile</h2>
        <input type="text" id="serviceNumber" disabled />
        <input type="text" id="rank" placeholder="Rank"/>
        <input type="text" id="name" placeholder="Full Name"/>
        <input type="text" id="unit" placeholder="Unit"/>
        <button onclick="saveProfile()">Save Profile</button>
        <button onclick="logout()">Logout</button>
      </div>

      <div class="mobile-card">
        <h2>New BFT Test</h2>
        <label>Test Date</label>
        <input type="date" id="testDate"/>
        <label>Age</label>
        <input type="number" id="ageAtTest" min="17" max="65" placeholder="Age"/>
        <label>Push-ups</label>
        <input type="number" id="pushUps" min="0" max="150" placeholder="Push-ups"/>
        <label>Sit-ups</label>
        <input type="number" id="sitUps" min="0" max="150" placeholder="Sit-ups"/>
        <label>Run Time</label>
        <input type="number" id="runMinutes" min="0" max="30" placeholder="Minutes"/>
        <input type="number" id="runSeconds" min="0" max="59" placeholder="Seconds"/>
        <button onclick="addTestRecord()">Add Test</button>
      </div>

      <div class="mobile-card">
        <h2>Test Records</h2>
        <div id="recordsContainer">Loading...</div>
        <button onclick="clearAllRecords()">Clear All</button>
        <button onclick="exportData()">Export</button>
      </div>
    </div>
  </div>

<script>
  // Initialize Supabase
  const supabaseUrl = 'https://rkdnosqkgnqcxbbjupwf.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrZG5vc3FrZ25xY3hiYmp1cHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzEyODgsImV4cCI6MjA3Mzk0NzI4OH0.JgBUV3exbaTUXQzO8pweeRKkmXIsf9xpPWF5ng53S6A';
  const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let currentUser = null;

  function showLogin() {
    document.getElementById('loginScreen').style.display = 'block';
    document.getElementById('signupScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'none';
  }

  function showSignup() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('signupScreen').style.display = 'block';
    document.getElementById('mainApp').style.display = 'none';
  }

  function showMainApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('signupScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
  }

  async function signup() {
    const serviceNumber = document.getElementById('signupServiceNumber').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const name = document.getElementById('signupName').value.trim();
    const rank = document.getElementById('signupRank').value.trim();
    const unit = document.getElementById('signupUnit').value.trim();

    if (!serviceNumber || !password || !confirmPassword || !name) {
      alert("Fill all fields");
      return;
    }
    if (password !== confirmPassword) {
      alert("Passwords do not match");
      return;
    }

    const email = serviceNumber + "@military.local";

    const { error } = await supabase.auth.signUp({ email, password });
    if (error) {
      alert(error.message);
      return;
    }

    const { error: profileError } = await supabase.from('profiles').upsert({ service_number: serviceNumber, name, rank, unit });
    if (profileError) {
      alert(profileError.message);
      return;
    }

    alert("Account created! Now please sign in.");
    showLogin();
  }

  async function login() {
    const serviceNumber = document.getElementById('loginServiceNumber').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!serviceNumber || !password) {
      alert("Enter all fields");
      return;
    }

    const email = serviceNumber + "@military.local";

    const { error, data } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      alert(error.message);
      return;
    }

    currentUser = serviceNumber;
    await loadUserData();
    showMainApp();
  }

  async function logout() {
    await supabase.auth.signOut();
    currentUser = null;
    showLogin();
  }

  async function loadUserData() {
    if (!currentUser) return;

    const { data: profile, error: profileError } = await supabase.from('profiles').select().eq('service_number', currentUser).single();
    if (profileError) {
      alert(profileError.message);
      return;
    }

    document.getElementById('serviceNumber').value = profile.service_number || '';
    document.getElementById('rank').value = profile.rank || '';
    document.getElementById('name').value = profile.name || '';
    document.getElementById('unit').value = profile.unit || '';

    await loadTestRecords();
  }

  async function saveProfile() {
    if (!currentUser) return;

    const rank = document.getElementById('rank').value.trim();
    const name = document.getElementById('name').value.trim();
    const unit = document.getElementById('unit').value.trim();

    const { error } = await supabase.from('profiles').upsert({ service_number: currentUser, rank, name, unit });
    if (error) {
      alert(error.message);
      return;
    }

    alert("Profile saved.");
  }

  async function addTestRecord() {
    if (!currentUser) return;

    const date = document.getElementById('testDate').value;
    const age = parseInt(document.getElementById('ageAtTest').value);
    const push_ups = parseInt(document.getElementById('pushUps').value);
    const sit_ups = parseInt(document.getElementById('sitUps').value);
    const run_minutes = parseInt(document.getElementById('runMinutes').value);
    const run_seconds = parseInt(document.getElementById('runSeconds').value);

    if (!date || !age || isNaN(push_ups) || isNaN(sit_ups) || isNaN(run_minutes) || isNaN(run_seconds)) {
      alert("Fill all fields");
      return;
    }

    const { error } = await supabase.from('records').insert([{
      service_number: currentUser,
      date,
      age,
      push_ups,
      sit_ups,
      run_minutes,
      run_seconds
    }]);
    if (error) {
      alert(error.message);
      return;
    }

    alert("Test record added.");
    await loadTestRecords();
  }

  async function loadTestRecords() {
    const { data, error } = await supabase.from('records').select().eq('service_number', currentUser).order('date', { ascending: false });
    const container = document.getElementById('recordsContainer');
    container.innerHTML = '';

    if (error) {
      container.innerHTML = `<p>Error loading records: ${error.message}</p>`;
      return;
    }

    if (!data.length) {
      container.innerHTML = '<p>No test records found.</p>';
      return;
    }

    data.forEach(record => {
      const div = document.createElement('div');
      div.textContent = `${record.date}: PU ${record.push_ups}, SU ${record.sit_ups}, Run ${record.run_minutes}:${String(record.run_seconds).padStart(2, '0')}`;
      container.appendChild(div);
    });
  }

  async function clearAllRecords() {
    const { error } = await supabase.from('records').delete().eq('service_number', currentUser);
    if (error) {
      alert(error.message);
      return;
    }
    alert("All records cleared.");
    await loadTestRecords();
  }

  async function exportData() {
    const { data, error } = await supabase.from('records').select().eq('service_number', currentUser);
    if (error) {
      alert(error.message);
      return;
    }
    if (!data.length) {
      alert("No records to export.");
      return;
    }
    let csv = "Date,Age,PushUps,SitUps,RunMinutes,RunSeconds\n";
    data.forEach(d => {
      csv += `${d.date},${d.age},${d.push_ups},${d.sit_ups},${d.run_minutes},${d.run_seconds}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "BFT_Records.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // On load, try to restore session from supabase
  window.onload = async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      currentUser = session.user.email.split('@')[0];
      await loadUserData();
      showMainApp();
    } else {
      showLogin();
    }
  };
</script>
</body>
</html>
