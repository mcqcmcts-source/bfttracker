<!-- Full original HTML and CSS below with Supabase connection and all buttons working -->

<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no"/>
  <title>Military BFT Tracker</title>

  <style>
    /* Original CSS as extracted from your file */
    body {
      margin: 0;
      background: linear-gradient(90deg, #0f1b0f 10%, #4ade80 90%);
      font-family: 'Inter', sans-serif;
      color: #86efac;
    }
    .mobile-container {
      padding: 10px;
      max-width: 480px;
      margin: 0 auto;
      background: #0f1b0f;
      border-radius: 8px;
      box-shadow: 0 0 10px #4ade80;
    }
    h1, h2 {
      text-align: center;
      color: #bf9b30;
    }
    input, button {
      font-size: 1rem;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: none;
    }
    input {
      width: 100%;
    }
    button {
      cursor: pointer;
      background-color: #4ade80;
      color: #0f1b0f;
      font-weight: 700;
    }
    button:hover {
      background-color: #86efac;
    }
    .hidden {
      display: none;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="mobile-container">

    <h1>Military BFT Tracker</h1>

    <div id="loginDiv">
      <input id="loginServiceNumber" placeholder="Service Number" />
      <input id="loginPassword" type="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <button id="showSignupBtn">Create Account</button>
    </div>

    <div id="signupDiv" class="hidden">
      <input id="signupServiceNumber" placeholder="Service Number" />
      <input id="signupPassword" type="password" placeholder="Password" />
      <input id="signupConfirmPassword" type="password" placeholder="Confirm Password" />
      <input id="signupName" placeholder="Full Name" />
      <input id="signupRank" placeholder="Rank" />
      <input id="signupUnit" placeholder="Unit" />
      <button id="signupBtn">Sign Up</button>
      <button id="showLoginBtn">Back to Login</button>
    </div>

    <div id="appDiv" class="hidden">
      <h2>Profile</h2>
      <input id="profileServiceNumber" disabled />
      <input id="profileRank" placeholder="Rank" />
      <input id="profileName" placeholder="Full Name" />
      <input id="profileUnit" placeholder="Unit" />
      <button id="saveProfileBtn">Save Profile</button>
      <button id="logoutBtn">Logout</button>

      <h2>Add BFT Test</h2>
      <input id="testDate" type="date" />
      <input id="testAge" type="number" placeholder="Age" min="17" max="65" />
      <input id="testPushUps" type="number" placeholder="Push-ups" min="0" max="150"/>
      <input id="testSitUps" type="number" placeholder="Sit-ups" min="0" max="150"/>
      <input id="testRunMinutes" type="number" placeholder="Run Minutes" min="0" max="30"/>
      <input id="testRunSeconds" type="number" placeholder="Run Seconds" min="0" max="59"/>
      <button id="addTestBtn">Add Test</button>

      <h2>Test Records</h2>
      <ul id="recordsList"></ul>
      <button id="clearRecordsBtn">Clear Records</button>
      <button id="exportBtn">Export CSV</button>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://rkdnosqkgnqcxbbjupwf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJrZG5vc3FrZ25xY3hiYmp1cHdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNzEyODgsImV4cCI6MjA3Mzk0NzI4OH0.JgBUV3exbaTUXQzO8pweeRKkmXIsf9xpPWF5ng53S6A';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // DOM elements
    const loginDiv = document.getElementById('loginDiv');
    const signupDiv = document.getElementById('signupDiv');
    const appDiv = document.getElementById('appDiv');
    const loginServiceNumber = document.getElementById('loginServiceNumber');
    const loginPassword = document.getElementById('loginPassword');
    const signupServiceNumber = document.getElementById('signupServiceNumber');
    const signupPassword = document.getElementById('signupPassword');
    const signupConfirmPassword = document.getElementById('signupConfirmPassword');
    const signupName = document.getElementById('signupName');
    const signupRank = document.getElementById('signupRank');
    const signupUnit = document.getElementById('signupUnit');
    const profileServiceNumber = document.getElementById('profileServiceNumber');
    const profileRank = document.getElementById('profileRank');
    const profileName = document.getElementById('profileName');
    const profileUnit = document.getElementById('profileUnit');
    const testDate = document.getElementById('testDate');
    const testAge = document.getElementById('testAge');
    const testPushUps = document.getElementById('testPushUps');
    const testSitUps = document.getElementById('testSitUps');
    const testRunMinutes = document.getElementById('testRunMinutes');
    const testRunSeconds = document.getElementById('testRunSeconds');
    const recordsList = document.getElementById('recordsList');

    let currentUser = null;

    // Show/hide views helpers
    function showLogin() {
      loginDiv.classList.remove('hidden');
      signupDiv.classList.add('hidden');
      appDiv.classList.add('hidden');
    }

    function showSignup() {
      loginDiv.classList.add('hidden');
      signupDiv.classList.remove('hidden');
      appDiv.classList.add('hidden');
    }

    function showApp() {
      loginDiv.classList.add('hidden');
      signupDiv.classList.add('hidden');
      appDiv.classList.remove('hidden');
    }

    // Event listeners for showing signup/login
    document.getElementById('showSignupBtn').onclick = showSignup;
    document.getElementById('showLoginBtn').onclick = showLogin;

    // Signup flow
    document.getElementById('signupBtn').onclick = async () => {
      if (signupPassword.value !== signupConfirmPassword.value) {
        alert('Passwords do not match');
        return;
      }
      if (!(signupServiceNumber.value && signupPassword.value && signupName.value)) {
        alert('Fill all required fields');
        return;
      }
      try {
        const email = signupServiceNumber.value + '@military.local';

        const { error: signUpError } = await supabase.auth.signUp({
          email,
          password: signupPassword.value,
        });
        if (signUpError) {
          alert(signUpError.message);
          return;
        }

        // Save user profile
        const { error: profileError } = await supabase.from('profiles').upsert({
          service_number: signupServiceNumber.value,
          name: signupName.value,
          rank: signupRank.value,
          unit: signupUnit.value,
        });
        if (profileError) alert(profileError.message);

        alert('Signup successful! Please login.');
        showLogin();
      } catch (error) {
        alert(error.message);
      }
    };

    // Login flow
    document.getElementById('loginBtn').onclick = async () => {
      try {
        const email = loginServiceNumber.value + '@military.local';
        const password = loginPassword.value;

        if (!loginServiceNumber.value || !password) {
          alert('Please enter Service Number and Password');
          return;
        }

        const { data, error } = await supabase.auth.signInWithPassword({
          email,
          password,
        });
        if (error) {
          alert(error.message);
          return;
        }

        currentUser = loginServiceNumber.value;
        await loadProfile();
        await loadRecords();
        showApp();
      } catch (error) {
        alert(error.message);
      }
    };

    // Logout
    document.getElementById('logoutBtn').onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      showLogin();
    };

    // Save profile
    document.getElementById('saveProfileBtn').onclick = async () => {
      if (!currentUser) return;
      try {
        const { error } = await supabase.from('profiles').upsert({
          service_number: currentUser,
          rank: profileRank.value,
          name: profileName.value,
          unit: profileUnit.value,
        });
        if (error) {
          alert(error.message);
          return;
        }
        alert('Profile saved');
      } catch (error) {
        alert(error.message);
      }
    };

    // Add test
    document.getElementById('addTestBtn').onclick = async () => {
      if (!currentUser) return;
      try {
        if (!testDate.value || !testAge.value) {
          alert('Please fill Test Date and Age');
          return;
        }

        const { error } = await supabase.from('records').insert({
          service_number: currentUser,
          date: testDate.value,
          age: parseInt(testAge.value),
          push_ups: parseInt(testPushUps.value) || 0,
          sit_ups: parseInt(testSitUps.value) || 0,
          run_minutes: parseInt(testRunMinutes.value) || 0,
          run_seconds: parseInt(testRunSeconds.value) || 0,
        });
        if (error) {
          alert(error.message);
          return;
        }

        alert('Test added!');
        clearTestForm();
        await loadRecords();
      } catch (error) {
        alert(error.message);
      }
    };

    // Clear records
    document.getElementById('clearRecordsBtn').onclick = async () => {
      if (!currentUser) return;
      try {
        const { error } = await supabase.from('records').delete().eq('service_number', currentUser);
        if (error) {
          alert(error.message);
          return;
        }
        alert('Records cleared!');
        await loadRecords();
      } catch (error) {
        alert(error.message);
      }
    };

    // Export records CSV
    document.getElementById('exportBtn').onclick = async () => {
      if (!currentUser) return;
      try {
        const { data, error } = await supabase.from('records').select('*').eq('service_number', currentUser);
        if (error) {
          alert(error.message);
          return;
        }

        let csv = 'Date,Age,PushUps,SitUps,RunMinutes,RunSeconds\n';
        data.forEach((r) => {
          csv += `${r.date},${r.age},${r.push_ups},${r.sit_ups},${r.run_minutes},${r.run_seconds}\n`;
        });

        let blob = new Blob([csv], { type: 'text/csv' });
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = 'bft_records.csv';
        a.click();
        URL.revokeObjectURL(url);
      } catch (error) {
        alert(error.message);
      }
    };

    // Helper: Load profile data from Supabase
    async function loadProfile() {
      try {
        const { data, error } = await supabase.from('profiles').select('*').eq('service_number', currentUser).single();
        if (error && error.code !== 'PGRST116') {
          alert(error.message);
          return;
        }

        if (data) {
          profileServiceNumber.value = data.service_number;
          profileRank.value = data.rank;
          profileName.value = data.name;
          profileUnit.value = data.unit;
        } else {
          profileServiceNumber.value = currentUser;
          profileRank.value = '';
          profileName.value = '';
          profileUnit.value = '';
        }
      } catch (error) {
        alert(error.message);
      }
    }

    // Helper: Load test records from Supabase
    async function loadRecords() {
      try {
        const { data, error } = await supabase.from('records').select('*').eq('service_number', currentUser).order('date', { ascending: false });
        if (error) {
          alert(error.message);
          return;
        }

        recordsList.innerHTML = '';
        if (!data.length) {
          recordsList.innerHTML = '<li>No records found</li>';
          return;
        }
        data.forEach((record) => {
          const li = document.createElement('li');
          li.textContent = `${record.date} - Age: ${record.age}, PU: ${record.push_ups}, SU: ${record.sit_ups}, Run: ${record.run_minutes}:${record.run_seconds.toString().padStart(2, '0')}`;
          recordsList.appendChild(li);
        });
      } catch (error) {
        alert(error.message);
      }
    }

    // Clear test form fields
    function clearTestForm() {
      testDate.value = '';
      testAge.value = '';
      testPushUps.value = '';
      testSitUps.value = '';
      testRunMinutes.value = '';
      testRunSeconds.value = '';
    }

    // On page load, check session and auto-login if possible
    window.onload = async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        let email = session.user.email;
        currentUser = email.split('@')[0];
        await loadProfile();
        await loadRecords();
        showApp();
      } else {
        showLogin();
      }
    };
  </script>
</body>
</html>
